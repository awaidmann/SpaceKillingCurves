<!DOCTYPE html/>
<html>
<head>
  <title>Continuity - An Unbroken Thought</title>
</head>
<body>
  <div
    id="main"
    style="height:100%; width:100%; background-color:gray;"
    >
    <canvas id="line-canvas" style="border:1px solid black"></canvas>
  </div>

  <script src="./bezier.js"></script>
  <script src="./transform.js"></script>

  <script src="https://d3js.org/d3-selection.v1.min.js"></script>
  <script src="https://d3js.org/d3-path.v1.min.js"></script>
  <script src="https://d3js.org/d3-shape.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  <script src="https://d3js.org/d3-ease.v1.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <script src="https://d3js.org/d3-selection.v1.min.js"></script>
  <script src="https://d3js.org/d3-timer.v1.min.js"></script>
  <script src="https://d3js.org/d3-transition.v1.min.js"></script>
  <script src="https://d3js.org/d3-drag.v1.min.js"></script>
  <script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <script>
    var POINT_FILTER = 5
    var prev = undefined
    var timer = undefined
    var lineData = []

    var transform = undefined

    var main = d3.select("div"),
        height = main.node().clientHeight,
        width = main.node().clientWidth

    var canvas = main.select("canvas")
      .attr("height", height)
      .attr("width", width)
    var ctx = canvas.node().getContext("2d")
    ctx.lineWidth = 2
    ctx.strokeStyle = "white"

    var line = d3.line().context(ctx)

    d3.selection()
      .on("keydown", setupAltControls)
      .on("keyup", teardownAltControls)

    setupDraw()

    function zoom() {
      ctx.save()
      ctx.clearRect(0, 0, width, height)
      transform = d3.event.transform
      ctx.translate(d3.event.transform.x, d3.event.transform.y)
      ctx.scale(d3.event.transform.k, d3.event.transform.k)
      drawForTransform()
      ctx.restore()
    }

    function record(e) {
      var curr = { x: d3.event.offsetX, y: d3.event.offsetY }
      if (prev) {
        draw(prev, curr)
        lineData.push(normalize(curr, transform))
      }
      prev = curr
    }

    function draw(prevCoor, currCoor) {
      ctx.beginPath()
      ctx.moveTo(prevCoor.x, prevCoor.y)
      ctx.lineTo(currCoor.x, currCoor.y)
      ctx.stroke()
    }

    function drawForTransform() {
      ctx.beginPath()
      line(lineData.map(p => [p.x, p.y]))
      ctx.stroke()
    }

    function drawControlPoints(beziers) {
      ctx.save()
      ctx.lineWidth = 1
      ctx.strokeStyle = "black"
      beziers.forEach(bezier =>
        drawControlPoint(bezier.s0.x, bezier.s0.y))
      ctx.restore()
    }

    function drawControlPoint(x, y) {
      ctx.beginPath()
      ctx.arc(x, y, 2, 0, 2*Math.PI)
      ctx.stroke()
    }

    function drawCubicBezier(beziers) {
      ctx.save()
      ctx.lineWidth = 2
      ctx.strokeStyle = "red"
      beziers.forEach(bezier => {
        ctx.beginPath()
        ctx.moveTo(bezier.s0.x, bezier.s0.y)
        ctx.bezierCurveTo(
          bezier.b0.x, bezier.b0.y,
          bezier.b1.x, bezier.b1.y,
          bezier.s1.x, bezier.s1.y
        )
        ctx.stroke()
      })
      ctx.restore()
    }

    function end() {
      if (lineData.length) {
        prev = invertNormalize(lineData[lineData.length - 1], transform)
        var controlPoints = calculateControlPoints(lineData)
        drawControlPoints(controlPoints)
        drawCubicBezier(controlPoints)
      }
    }

    function setupAltControls() {
      if (d3.event.metaKey) {
        setupZoom()
        teardownDraw()
      }
    }

    function teardownAltControls() {
      if (d3.event.key === "Meta") {
        teardownZoom()
        setupDraw()
      }
    }

    function setupDraw() {
      canvas.on("mousedown", () => canvas.on("mousemove", record))
      canvas.on("mouseup", () => canvas.on("mousemove", null))
    }

    function teardownDraw() {
      canvas.on("mousedown", null)
      canvas.on("mousemove", null)
      canvas.on("mouseup", null)
    }

    function setupZoom() {
      canvas.call(d3.zoom()
        .on("zoom", zoom)
        .on("end", end)
      )
    }

    function teardownZoom() {
      canvas
        .on(".zoom", null)
        .on(".end", null)
    }

  </script>
</body>
</html>
