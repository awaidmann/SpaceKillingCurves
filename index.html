<!DOCTYPE html/>
<html>
<head>
  <title>Continuity - An Unbroken Thought</title>
</head>
<body>
  <div
    id="main"
    style="height:100%; width:100%; background-color:gray;"
    >
    <canvas id="line-canvas" style="border:1px solid black"></canvas>
  </div>

  <script src="https://d3js.org/d3-selection.v1.min.js"></script>
  <script src="https://d3js.org/d3-path.v1.min.js"></script>
  <script src="https://d3js.org/d3-shape.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  <script src="https://d3js.org/d3-ease.v1.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <script src="https://d3js.org/d3-selection.v1.min.js"></script>
  <script src="https://d3js.org/d3-timer.v1.min.js"></script>
  <script src="https://d3js.org/d3-transition.v1.min.js"></script>
  <script src="https://d3js.org/d3-drag.v1.min.js"></script>
  <script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <script>
    var prev = undefined
    var timer = undefined
    var lineData = []

    var transform = undefined

    var main = d3.select("div"),
        height = main.node().clientHeight,
        width = main.node().clientWidth

    var canvas = main.select("canvas")
      .attr("height", height)
      .attr("width", width)
    var ctx = canvas.node().getContext("2d")
    ctx.lineWidth = 2
    ctx.strokeStyle = "white"

    var line = d3.line().context(ctx)

    canvas.call(d3.zoom()
      .on("zoom", zoom)
      .on("end", end)
    )
    canvas.on("mousemove.draw", record)

    function zoom() {
      ctx.save()
      ctx.clearRect(0, 0, width, height)
      transform = d3.event.transform
      ctx.translate(d3.event.transform.x, d3.event.transform.y)
      ctx.scale(d3.event.transform.k, d3.event.transform.k)
      drawForTransform()
      ctx.restore()
    }

    function record(e) {
      if (d3.event.metaKey) {
        var curr = [d3.event.offsetX, d3.event.offsetY]
        if (prev) {
          draw(prev, curr)
          lineData.push(normalize(curr, transform))
        }
        prev = curr
      }
    }

    function draw(prevCoor, currCoor) {
      ctx.beginPath()
      ctx.moveTo(prevCoor[0], prevCoor[1])
      ctx.lineTo(currCoor[0], currCoor[1])
      ctx.stroke()
    }

    function drawForTransform() {
      ctx.beginPath()
      line(lineData)
      ctx.stroke()
    }

    function normalize(coor, t) {
      return t ? [(coor[0] - t.x)/t.k, (coor[1] - t.y)/t.k] : coor
    }

    function invertNormalize(coor, t) {
      return t ? [(coor[0]*t.k + t.x), (coor[1]*t.k + t.y)] : coor
    }

    function end() {
      if (lineData.length) {
        prev = invertNormalize(lineData[lineData.length - 1], transform)
      }
    }
  </script>
</body>
</html>
